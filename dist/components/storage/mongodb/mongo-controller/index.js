"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Promise=require("bluebird"),mongoose=require("mongoose"),MongoController=function(){return function(e,n,t,i,o,r,u,s,c){var d=this;this.events=e,this.Model=n,this.mapDetails=t,this.checkThrow=i,this.makeConditions=o,this.makeSortCriteria=r,this.generateAddDetails=u,this.generateUpdateDetails=s,this.convertToAbstract=c,this.get=function(e,n,t,i){return void 0===i&&(i=!1),d.checkThrow(i).then(function(n){return e?d.makeConditions(e):Promise.resolve({})}).then(function(e){return n?d.makeSortCriteria(n).then(function(n){return Promise.resolve({conditions:e,sortString:n})}):Promise.resolve({conditions:e,sortString:""})}).then(function(e){return d.find(e.conditions,e.sortString,t)}).then(function(e){return d.convertToAbstract(e)}).then(function(i){return new Promise(function(o,r){d.events.got({filtrationCriteria:e,sortCriteria:n,limit:t,ids:i.map(function(e){return e.id})}),o()}),Promise.resolve(i)}).catch(function(i){return console.log(">"+i),new Promise(function(o,r){d.events.getFailed({filtrationCriteria:e,sortCriteria:n,limit:t,reason:i}),o()}),Promise.reject({identifier:"GetFailed",data:{reason:i}})})},this.getById=function(e,n){return void 0===n&&(n=!1),d.checkThrow(n).then(function(n){return d.findById(mongoose.Types.ObjectId(e))}).then(function(e){return d.convertToAbstract([e])}).then(function(n){return new Promise(function(n,t){d.events.gotById({id:e})}),Promise.resolve(n[0])}).catch(function(n){return console.log(">>"+n),new Promise(function(t,i){d.events.getByIdFailed({id:e,reason:n}),t()}),n.identifier&&"DocumentNotFound"===n.identifier?Promise.reject(n):Promise.reject({identifier:"GetByIdFailed",data:{reason:n}})})},this.addBatch=function(e,n){return void 0===n&&(n=!1),d.checkThrow(n).then(function(n){return d.saveMultipleDocuments(d.generateAddDetails(e))}).then(function(e){return d.convertToAbstract(e)}).then(function(e){return new Promise(function(n,t){d.events.added({documents:e}),n()}),Promise.resolve(e)}).catch(function(n){return new Promise(function(t,i){d.events.addFailed({details:e,reason:n}),t()}),Promise.reject({identifier:"AddBatchFailed",data:{reason:n}})})},this.add=function(e,n){return void 0===n&&(n=!1),d.checkThrow(n).then(function(n){return d.saveDocument(d.generateAddDetails([e])[0])}).then(function(e){return d.convertToAbstract([e])}).then(function(e){return new Promise(function(n,t){d.events.added({documents:e}),n()}),Promise.resolve(e[0])}).catch(function(n){return new Promise(function(t,i){d.events.addFailed({details:[e],reason:n}),t()}),Promise.reject({identifier:"AddFailed",data:{reason:n}})})},this.update=function(e,n,t){return void 0===t&&(t=!1),d.checkThrow(t).then(function(n){return d.makeConditions(e)}).then(function(e){return d.find(e,null,null)}).then(function(e){return Promise.all(e.map(function(e){return d.generateUpdateDetails(e,n).then(function(e){return new Promise(function(n,t){e.save(function(i){i?t(i):n(e)})})})}))}).then(function(e){return d.convertToAbstract(e)}).then(function(n){return new Promise(function(t,i){d.events.updated({conditions:e,documents:n}),t()}),Promise.resolve(n)}).catch(function(t){return new Promise(function(i,o){d.events.updateFailed({conditions:e,updates:n,reason:t}),i()}),Promise.reject({identifier:"UpdateFailed",data:{reason:t}})})},this.updateById=function(e,n,t){return void 0===t&&(t=!1),d.checkThrow(t).then(function(n){return d.findById(mongoose.Types.ObjectId(e))}).then(function(e){return d.generateUpdateDetails(e,n).then(function(e){return new Promise(function(n,t){e.save(function(i){i?t(i):n(e)})})})}).then(function(e){return d.convertToAbstract([e])}).then(function(n){return new Promise(function(t,i){d.events.updated({id:e,documents:n}),t()}),Promise.resolve(n[0])}).catch(function(t){return new Promise(function(i,o){d.events.updateFailed({id:e,updates:n,reason:t}),i()}),t.identifier&&"DocumentNotFound"===t.identifier?Promise.reject(t):Promise.reject({identifier:"UpdateFailed",data:{reason:t}})})},this.remove=function(e,n){return void 0===n&&(n=!1),d.checkThrow(n).then(function(n){return d.makeConditions(e)}).then(function(e){return d.removeDocuments(e)}).then(function(n){return new Promise(function(n,t){d.events.removed({conditions:e}),n()}),Promise.resolve()}).catch(function(n){return new Promise(function(t,i){d.events.removeFailed({conditions:e,reason:n}),t()}),Promise.reject({identifier:"RemoveFailed",data:{reason:n}})})},this.removeById=function(e,n){return d.checkThrow(n).then(function(n){return d.removeDocuments({_id:mongoose.Types.ObjectId(e)})}).then(function(n){return new Promise(function(n,t){d.events.removed({id:e}),n()}),Promise.resolve()}).catch(function(n){return new Promise(function(t,i){d.events.removeFailed({id:e,reason:n}),t()}),Promise.reject({identifier:"RemoveFailed",data:{reason:n}})})},this.find=function(e,n,t){return e=e||"",n=n||"-updatedAt",t=t||50,new Promise(function(i,o){d.Model.find(e).sort(n).limit(t).exec(function(e,n){e?o(e):i(n)})})},this.findById=function(e){return new Promise(function(n,t){d.Model.findById(e.toHexString(),function(e,i){if(e)return t(e);i?n(i):t({identifier:"DocumentNotFound",data:{}})})})},this.saveDocument=function(e){return new Promise(function(n,t){var i=new d.Model(e);i.save(function(e){e?t(e):n(i)})})},this.saveMultipleDocuments=function(e){return new Promise(function(n,t){d.Model.insertMany(e,function(e,i){e?t(e):n(i)})})},this.updateDocuments=function(e,n){return new Promise(function(t,i){var o=[];d.Model.find(e).exec(function(e,r){if(e)return i(e);Promise.all(r.map(function(e){return new Promise(function(t,i){d.mapDetails(n,e),e.save(function(n){n?i(n):(o.push(e),t())})})})).then(function(e){t(o)})})})},this.removeDocuments=function(e){return new Promise(function(n,t){d.Model.find(e).remove(function(e){e?t(e):n()})})}}}();exports.default=MongoController;