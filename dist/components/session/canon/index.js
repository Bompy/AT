"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Promise=require("bluebird"),expressSession=require("express-session"),Canon=function(){return function(e,r,n,t){var i=this;this.events=e,this.checkThrow=r,this.getUserById=n,this.production=t,this.middleware=[],this.signedIn=function(e){return!!e.session.userId},this.setCurrentUser=function(e,r,n){return void 0===n&&(n=!1),i.checkThrow(n).then(function(n){return r.session.userId=e,new Promise(function(n,t){i.events.setCurrentUser({userId:e,req:r}),n()}),Promise.resolve()}).catch(function(n){return new Promise(function(t,s){i.events.setCurrentUserFailed({userId:e,req:r,reason:n}),t()}),Promise.reject({identifier:"SetCurrentUserFailed",data:{reason:n}})})},this.getUserId=function(e){return e.session.userId?e.session.userId:null},this.getCurrentUser=function(e,r){return void 0===r&&(r=!1),i.checkThrow(r).then(function(r){return e.session.userId?i.getUserById(e.session.userId):(new Promise(function(r,n){i.events.noCurrentUser({req:e}),r()}),Promise.reject({identifier:"NoCurrentUser",data:{}}))}).catch(function(r){return new Promise(function(n,t){i.events.getCurrentUserFailed({req:e,reason:r}),n()}),r.identifier&&"DocumentNotFound"===r.identifier?Promise.reject(r):r.identifier&&"NoCurrentUser"===r.identifier?Promise.reject(r):Promise.reject({identifier:"GetCurrentUserFailed",data:{reason:r}})})},this.signOut=function(e,r){return void 0===r&&(r=!1),i.checkThrow(r).then(function(r){return new Promise(function(r,n){e.session.destroy(function(e){e?n(e):r()})})}).catch(function(r){return new Promise(function(n,t){i.events.signOutFailed({req:e,reason:r}),n()}),Promise.reject({identifier:"SignOutFailed",data:{reason:r}})})},this.middlewareConfiguration=expressSession({name:"Athena",secret:"secregrandt",resave:!0,saveUninitialized:!0,cookie:{secure:!!this.production,httpOnly:!0}}),this.middleware.push(function(e,r,n){if(e.session)return n();var t=1,s=function(o){if(o)throw o;if(e.session)return n();if((t+=1)>3)throw new Error("Session: Couldn't retain session");i.middlewareConfiguration(e,r,s)};s("")})}}();exports.default=Canon;