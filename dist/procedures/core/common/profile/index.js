"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Promise=require("bluebird"),environment=require("../../../../environment"),supportDetails=require("../../../../environment/support-details"),Profile=function(){return function(e,t,r,n,i,s,o,u,d,a,c,f,h,m,l){var P=this;this.events=e,this.checkThrow=t,this.cleanUsers=r,this.newEmailAddressTemplate=n,this.passwordResetTemplate=i,this.sendEmail=s,this.authPassword=o,this.createHash=u,this.signedIn=d,this.signOutSession=a,this.generateRandomNumber=c,this.getUserById=f,this.updateUser=h,this.updateUserById=m,this.removeUserById=l,this.getUserDetails=function(e,t){return P.checkThrow(t).then(function(t){return P.getUserById(e)}).then(function(e){return P.cleanUsers([e])}).then(function(e){return Promise.resolve(e[0])}).catch(function(e){return e&&"DocumentNotFound"===e.identifier?Promise.reject(e):Promise.reject({identifier:"GetUserDetailsFailed",data:{reason:e}})})},this.updateUserDetails=function(e,t,r){return P.checkThrow(r).then(function(r){return P.updateUserById(e,t)}).then(function(e){return P.cleanUsers([e])}).then(function(e){return Promise.resolve(e[0])}).catch(function(e){return e.identifier&&"DocumentNotFound"===e.identifier?Promise.reject(e):Promise.reject({identifier:"UpdateUserDetailsFailed",data:{reason:e}})})},this.changeEmailAddress=function(e,t,r,n,i){return P.checkThrow(i).then(function(r){return P.authPassword(e,t)}).then(function(e){return Promise.all([P.generateRandomNumber(1543,9812),P.generateRandomNumber(5123,7623)])}).then(function(e){return Promise.resolve(String(e[0])+String(e[1]))}).then(function(t){return P.updateUserById(e,{emailAddress:r,verification:{verified:!1,verificationCode:t}})}).then(function(e){return P.newEmailAddressTemplate(r,e.id,e.verification.verificationCode,supportDetails.default.phoneNumber,supportDetails.default.emailAddress)}).then(function(e){return P.sendEmail(supportDetails.default.sendingAddress,[r],environment.default.applicationName+" | Account Verification",e)}).then(function(e){return P.signedIn(n)?P.signOutSession(n):Promise.resolve()}).catch(function(e){return e.identifier&&"DocumentNotFound"===e.identifier?Promise.reject(e):e.identifier&&"InvalidPassword"===e.identifier?Promise.reject(e):Promise.reject({identifier:"ChangeEmailAddressFailed",data:{reason:e}})})},this.changePassword=function(e,t,r,n){return P.checkThrow(n).then(function(r){return P.authPassword(e,t)}).then(function(e){return P.createHash(r)}).then(function(t){return P.updateUserById(e,{password:t})}).then(function(e){return Promise.resolve()}).catch(function(e){return e.identifier&&"DocumentNotFound"===e.identifier?Promise.reject(e):e.identifier&&"InvalidPassword"===e.identifier?Promise.reject(e):Promise.reject({identifier:"ChangePasswordFailed",data:{reason:e}})})},this.requestPasswordResetCode=function(e,t){return P.checkThrow(t).then(function(e){return Promise.all([P.generateRandomNumber(1543,9812),P.generateRandomNumber(5123,7623)])}).then(function(e){return Promise.resolve(String(e[0])+String(e[1]))}).then(function(t){return P.updateUser({emailAddress:e},{resetCode:t}).then(function(e){return Promise.resolve({userId:e[0].id,resetCode:t})})}).then(function(t){return P.passwordResetTemplate(e,t.userId,t.resetCode,supportDetails.default.phoneNumber,supportDetails.default.emailAddress).then(function(t){return Promise.resolve({html:t,emailAddress:e})})}).then(function(e){return P.sendEmail(supportDetails.default.sendingAddress,[e.emailAddress],environment.default.applicationName+" | Account Verification",e.html)}).catch(function(e){return e.identifier&&"DocumentNotFound"===e.identifier?Promise.reject(e):Promise.reject({identifier:"ResetPasswordFailed",data:{reason:e}})})},this.resetPassword=function(e,t,r,n){return P.checkThrow(n).then(function(t){return P.getUserById(e)}).then(function(e){return new Promise(function(r,n){e.resetCode&&e.resetCode==t?r():n({identifier:"InvalidResetCode"})})}).then(function(e){return P.createHash(r)}).then(function(t){return P.updateUserById(e,{resetCode:"",password:t})}).then(function(e){return Promise.resolve(e.password)}).catch(function(e){return e.identifier&&"DocumentNotFound"===e.identifier?Promise.reject(e):e.identifier&&"InvalidResetCode"===e.identifier?Promise.reject(e):Promise.reject({identifier:"ResetPasswordFailed",data:{reason:e}})})},this.deleteAccount=function(e,t,r){return P.checkThrow(r).then(function(r){return P.authPassword(e,t)}).then(function(t){P.removeUserById(e)}).catch(function(e){return e.identifier&&"DocumentNotFound"===e.identifier?Promise.reject(e):e.identifier&&"InvalidPassword"===e.identifier?Promise.reject(e):Promise.reject({identifier:"DeleteAccountFailed",data:{reason:e}})})}}}();exports.default=Profile;