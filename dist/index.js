"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var http=require("http"),express=require("express"),path=require("path"),helmet=require("helmet"),favicon=require("serve-favicon"),compression=require("compression"),bodyParser=require("body-parser"),environment_1=require("./environment"),event_listener_1=require("./event-listener"),components_1=require("./components"),procedures_1=require("./procedures"),routes_1=require("./routes"),app=express(),server=http.createServer(app),eventListenerInstance=event_listener_1.default(),componentsInstance=components_1.default(eventListenerInstance.emit,environment_1.default.production,server),proceduresInstance=procedures_1.default(eventListenerInstance.emit,componentsInstance);eventListenerInstance.updateReferences(componentsInstance,proceduresInstance),app.set("trust proxy",1),app.set("views",path.join(__dirname,"views")),app.set("view engine","pug"),app.locals.basedir=__dirname+"/public";var mware={helmet:[helmet()],favicon:[favicon(path.join(__dirname,"/public/favicon.ico"))],compression:[compression()],express_static:[express.static(__dirname+"/public")],bodyParser_urlEncoded:[bodyParser.urlencoded({extended:!1})],bodyParser_json:[bodyParser.json()]},indexableComponents={helpers:componentsInstance.helpers,storage:componentsInstance.storage,session:componentsInstance.session,authentication:componentsInstance.authentication,communication:componentsInstance.communication,response:componentsInstance.response};for(var utility in indexableComponents)indexableComponents.hasOwnProperty(utility)&&componentsInstance.helpers.mware.retrieveMwareLists(mware,utility,indexableComponents[utility]);var mware_order=["helmet","favicon","compression","express_static","bodyParser_urlEncoded","bodyParser_json","session","authentication"];mware_order.forEach(function(e){mware[e]&&mware[e].length&&mware[e].forEach(function(e){app.use([e])})}),routes_1.default(eventListenerInstance,componentsInstance,proceduresInstance,app),app.use(function(e,n,r,s){if(r.headersSent)return s(e);var t=e.stack?e.stack:e;t?console.log("Last Error Handler: "+t):console.log("Last Error Handler: Couldn't retrieve error info"),r.status(500).json({success:!1,message:"Something went wrong. Please try again."})}),server.listen(process.env.PORT||1111,function(){var e=server.address().port;console.log(environment_1.default.applicationName+" now running on port : "+e)});