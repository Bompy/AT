"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Promise=require("bluebird"),express=require("express"),environment=require("../../../../environment"),supportDetails=require("../../../../environment/support-details");exports.default=function(e,n,i,s,r,t,o){var a=express.Router();return a.post("/signUp",function(a,d,u){if(!a.body.emailAddress)return o(d,"passpoint",!1,"Email address is missing",{innerContext:"sign-up"});if(!a.body.password)return o(d,"passpoint",!1,"Password is missing",{innerContext:"sign-up"});var p;return e({emailAddress:a.body.emailAddress},null,1).then(function(e){return e.length?Promise.reject({identifier:"AddressAlreadyTaken"}):Promise.all([n(1543,9812),n(5123,7623)])}).then(function(e){return p=String(e[0])+String(e[1]),i(a.body.password)}).then(function(e){return s({emailAddress:a.body.emailAddress,accessLevel:"consumer",password:e,verification:{verified:!1,verificationCode:p},subscriptions:[],activeApps:[]})}).then(function(e){return r(a.body.emailAddress,e.id,p,supportDetails.default.phoneNumber,supportDetails.default.emailAddress)}).then(function(e){return t(supportDetails.default.sendingAddress,[a.body.emailAddress],environment.default.applicationName+" | Account Verification",e)}).then(function(e){return console.log("sent email"),o(d,"passpoint",!0,"Done. A verification email has been sent to your email address.",{innerContext:"sign-up"})}).catch(function(e){return e.identifier&&"AddressAlreadyTaken"==e.identifier?o(d,"passpoint",!1,"That email address is already in use",{innerContext:"sign-up"}):e.identifier&&"SendEmailFailed"==e.identifier?o(d,"passpoint",!1,"Done, but couldn't send a verification email, contact support",{innerContext:"sign-up"}):o(d,"passpoint",!1,null,{innerContext:"sign-up"})})}),a};